description "Welcome to Ubuntu"
author "Michael Terry <michael.terry@canonical.com>"

start on starting xsession-init
task

expect stop

env RUN_FILE=".config/ubuntu-system-settings/wizard-has-run"

pre-start script
    if [ -e $HOME/$RUN_FILE ]; then
        stop
    else
        # Tell unity-mir to raise SIGSTOP after we start
        initctl set-env UNITY_MIR_EMITS_SIGSTOP=1

        if [ -n "$MIR_SOCKET" ]; then
            if [ -z "$WIZARD_MIR_SOCKET" ]; then
                # Save original value of MIR_SOCKET in case we are restarted,
                # as we modify the variable for future jobs, including ourself.
                WIZARD_MIR_SOCKET=$MIR_SOCKET
                initctl set-env --global WIZARD_MIR_SOCKET=$WIZARD_MIR_SOCKET
            fi

            # Point wizard at unity-system-compositor
            MIR_SERVER_FILE=$XDG_RUNTIME_DIR/mir_socket
            initctl set-env MIR_SERVER_FILE=$MIR_SERVER_FILE
            initctl set-env MIR_SERVER_HOST_SOCKET=$WIZARD_MIR_SOCKET

            # Point all future jobs in this session to our Mir socket instead of
            # unity-system-compositor's socket.
            initctl set-env --global MIR_SOCKET=$MIR_SERVER_FILE
        fi

        # Remove the socket if still there
        if [ -S "$MIR_SERVER_FILE" ]; then
            rm "$MIR_SERVER_FILE"
        fi

        initctl emit indicator-services-start
    fi
end script

exec system-settings-wizard

post-start script
    start maliit-server # we need OSK for "Wi-Fi" page
end script

post-stop script
    if ! [ -e $HOME/$RUN_FILE ]; then
        mkdir -p $(dirname $HOME/$RUN_FILE)
        touch $HOME/$RUN_FILE

        # We didn't stop at the pre-start script, so we restore things
        stop maliit-server
        initctl set-env --global MIR_SOCKET=$WIZARD_MIR_SOCKET
        initctl unset-env --global WIZARD_MIR_SOCKET
    fi
end script
